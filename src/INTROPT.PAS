uses crt,utils,sbunit;

const beatdec=1;
      beatdel=64;

const vertices=244;
const faces=480;
const scaler=16;

const xcords:array[0..vertices-1] of integer=(
-167,-167,-215,-215,-139,-133,-127,-121,-116,-110,-105,-96,-88,-82,-77,-75,-74,
-75,-77,-82,-88,-96,-106,-110,-115,-120,-124,-129,-134,-167,-167,-142,-137,
-132,-128,-125,-123,-122,-123,-125,-128,-132,-136,-141,27,27,-20,-20,-66,
-66,73,73,224,224,89,89,89,91,92,95,99,109,122,135,148,
158,166,169,172,174,176,177,177,177,174,171,167,162,157,150,144,
140,137,136,136,91,92,92,93,94,95,98,105,113,123,134,145,
157,165,174,182,189,197,204,209,215,219,222,224,225,224,223,222,
219,217,213,207,195,182,170,160,157,-167,-167,-215,-215,-139,-133,-127,
-121,-116,-110,-105,-96,-88,-82,-77,-75,-74,-75,-77,-82,-88,-96,-106,
-110,-115,-120,-124,-129,-134,-167,-167,-142,-137,-132,-128,-125,-123,-122,-123,
-125,-128,-132,-136,-141,27,27,-20,-20,-66,-66,73,73,224,224,89,
89,89,91,92,95,99,109,122,135,148,158,166,169,172,174,176,
177,177,177,174,171,167,162,157,150,144,140,137,136,136,91,92,
92,93,94,95,98,105,113,123,134,145,157,165,174,182,189,197,
204,209,215,219,222,224,225,224,223,222,219,217,213,207,195,182,
170,160,157);

const ycords:array[0..vertices-1] of integer=(
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,51,51,51,51,51,51,51,
51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,
51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,
51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,
51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,
51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,
51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,
51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,
51,51,51);

const zcords:array[0..vertices-1] of integer=(
38,-11,-11,150,150,149,149,149,148,146,144,139,131,123,113,103,93,
82,72,62,54,47,42,41,39,39,38,38,38,110,75,75,76,
77,79,83,87,93,99,103,106,108,110,110,107,-11,-11,107,107,
150,150,107,29,-11,-11,-8,-3,4,13,21,27,36,46,56,65,
72,78,81,83,86,90,93,98,103,107,110,113,114,115,113,109,
103,96,89,82,82,89,95,102,108,115,121,131,139,145,150,153,
153,153,152,150,148,145,141,136,131,125,118,110,101,96,90,85,
79,74,70,63,55,46,37,31,29,38,-11,-11,150,150,149,149,
149,148,146,144,139,131,123,113,103,93,82,72,62,54,47,42,
41,39,39,38,38,38,110,75,75,76,77,79,83,87,93,99,
103,106,108,110,110,107,-11,-11,107,107,150,150,107,29,-11,-11,
-8,-3,4,13,21,27,36,46,56,65,72,78,81,83,86,90,
93,98,103,107,110,113,114,115,113,109,103,96,89,82,82,89,
95,102,108,115,121,131,139,145,150,153,153,153,152,150,148,145,
141,136,131,125,118,110,101,96,90,85,79,74,70,63,55,46,
37,31,29);

const facea:array[0..faces-1] of word=(
38,39,40,11,12,13,14,40,15,40,41,41,41,42,42,16,17,
17,18,19,19,20,21,22,22,23,24,24,25,26,27,27,28,
42,43,43,29,29,30,0,0,0,0,1,44,44,49,44,44,
45,55,56,57,57,57,58,59,60,61,62,63,64,64,64,65,
65,66,66,67,86,86,87,68,68,69,88,88,89,90,90,91,
92,93,93,94,95,95,96,96,97,98,98,99,99,100,101,101,
102,70,70,70,71,71,71,72,72,72,72,72,73,73,73,73,
74,74,74,74,74,0,0,1,1,2,2,3,3,4,4,5,
5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,
13,14,14,15,15,16,16,17,17,18,18,19,19,20,20,21,
21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,
29,30,30,31,31,32,32,33,33,34,34,35,35,36,36,37,
37,38,38,39,39,40,40,41,41,42,42,43,43,44,44,45,
45,46,46,47,47,48,48,49,49,50,50,51,51,52,52,53,
53,54,54,55,55,56,56,57,57,58,58,59,59,60,60,61,
61,62,62,63,63,64,64,65,65,66,66,67,67,68,68,69,
69,70,70,71,71,72,72,73,73,74,74,75,75,76,76,77,
77,78,78,79,79,80,80,81,81,82,82,83,83,84,84,85,
85,86,86,87,87,88,88,89,89,90,90,91,91,92,92,93,
93,94,94,95,95,96,96,97,97,98,98,99,99,100,100,101,
101,102,102,103,103,104,104,105,105,106,106,107,107,108,108,109,
109,110,110,111,111,112,112,113,113,114,114,115,115,116,116,117,
117,118,118,119,119,120,120,121,121,132,132,132,159,159,159,159,
131,159,130,130,129,128,128,127,159,159,158,158,158,157,157,157,
157,156,156,156,155,155,155,155,154,154,126,126,125,125,124,124,
154,153,152,124,124,172,171,169,169,168,168,175,175,175,174,243,
243,243,243,243,243,243,243,242,241,241,240,240,239,239,206,205,
205,239,238,238,205,204,204,204,203,203,203,203,202,202,202,201,
201,200,200,200,199,199,198,198,198,197,197,238,237,236,236,235,
234,234,233,232,231,230,230,229,228,227,227,226,225,224,197);

const faceb:array[0..faces-1] of word=(
37,38,39,10,11,12,13,10,14,9,40,8,7,41,6,15,16,
37,17,18,36,19,20,21,35,22,23,34,24,25,26,33,27,
5,42,4,43,3,29,28,32,31,30,0,51,50,48,49,47,
44,54,55,56,53,52,57,58,59,60,61,62,63,121,120,64,
119,65,118,66,85,84,86,67,117,68,87,83,88,89,82,90,
91,92,81,93,94,80,95,79,96,97,78,98,77,99,100,76,
101,69,116,115,70,114,113,71,112,111,110,109,72,108,107,106,
73,105,104,103,102,1,123,2,124,3,125,4,126,5,127,6,
128,7,129,8,130,9,131,10,132,11,133,12,134,13,135,14,
136,15,137,16,138,17,139,18,140,19,141,20,142,21,143,22,
144,23,145,24,146,25,147,26,148,27,149,28,150,0,122,30,
152,31,153,32,154,33,155,34,156,35,157,36,158,37,159,38,
160,39,161,40,162,41,163,42,164,43,165,29,151,45,167,46,
168,47,169,48,170,49,171,50,172,51,173,44,166,53,175,54,
176,55,177,56,178,57,179,58,180,59,181,60,182,61,183,62,
184,63,185,64,186,65,187,66,188,67,189,68,190,69,191,70,
192,71,193,72,194,73,195,74,196,75,197,76,198,77,199,78,
200,79,201,80,202,81,203,82,204,83,205,84,206,85,207,86,
208,87,209,88,210,89,211,90,212,91,213,92,214,93,215,94,
216,95,217,96,218,97,219,98,220,99,221,100,222,101,223,102,
224,103,225,104,226,105,227,106,228,107,229,108,230,109,231,110,
232,111,233,112,234,113,235,114,236,115,237,116,238,117,239,118,
240,119,241,120,242,121,243,52,174,159,160,161,132,133,134,135,
132,136,131,162,130,129,163,128,137,138,159,139,140,158,141,142,
143,157,144,145,156,146,147,148,155,149,127,164,126,165,125,151,
150,154,153,152,122,173,172,170,171,169,166,176,177,178,175,174,
179,180,181,182,183,184,185,243,242,186,241,187,240,188,207,206,
208,189,239,190,209,205,210,211,204,212,213,214,203,215,216,202,
217,201,218,219,200,220,199,221,222,198,223,191,238,237,192,236,
235,193,234,233,232,231,194,230,229,228,195,227,226,225,224);

const facec:array[0..faces-1] of word=(
10,10,10,37,37,37,37,9,37,8,8,7,6,6,5,37,37,
36,36,36,35,35,35,35,34,34,34,33,33,33,33,32,32,
4,4,3,3,2,2,32,31,30,2,2,50,49,47,47,46,
46,53,53,53,52,121,121,121,121,121,121,121,121,120,119,119,
118,118,117,117,84,83,83,117,116,116,83,82,82,82,81,81,
81,81,80,80,80,79,79,78,78,78,77,77,76,76,76,75,
75,116,115,114,114,113,112,112,111,110,109,108,108,107,106,105,
105,104,103,102,75,123,122,124,123,125,124,126,125,127,126,128,
127,129,128,130,129,131,130,132,131,133,132,134,133,135,134,136,
135,137,136,138,137,139,138,140,139,141,140,142,141,143,142,144,
143,145,144,146,145,147,146,148,147,149,148,150,149,122,150,152,
151,153,152,154,153,155,154,156,155,157,156,158,157,159,158,160,
159,161,160,162,161,163,162,164,163,165,164,151,165,167,166,168,
167,169,168,170,169,171,170,172,171,173,172,166,173,175,174,176,
175,177,176,178,177,179,178,180,179,181,180,182,181,183,182,184,
183,185,184,186,185,187,186,188,187,189,188,190,189,191,190,192,
191,193,192,194,193,195,194,196,195,197,196,198,197,199,198,200,
199,201,200,202,201,203,202,204,203,205,204,206,205,207,206,208,
207,209,208,210,209,211,210,212,211,213,212,214,213,215,214,216,
215,217,216,218,217,219,218,220,219,221,220,222,221,223,222,224,
223,225,224,226,225,227,226,228,227,229,228,230,229,231,230,232,
231,233,232,234,233,235,234,236,235,237,236,238,237,239,238,240,
239,241,240,242,241,243,242,174,243,160,161,162,133,134,135,136,
162,137,162,163,163,163,164,164,138,139,139,140,141,141,142,143,
144,144,145,146,146,147,148,149,149,150,164,165,165,151,151,152,
122,122,122,122,123,166,166,171,166,166,167,177,178,179,179,179,
180,181,182,183,184,185,186,186,186,187,187,188,188,189,208,208,
209,190,190,191,210,210,211,212,212,213,214,215,215,216,217,217,
218,218,219,220,220,221,221,222,223,223,224,192,192,192,193,193,
193,194,194,194,194,194,195,195,195,195,196,196,196,196,196);

const paldata:array[0..767] of integer=(
0,0,0,0,1,6,0,1,6,0,1,
6,0,1,7,0,1,7,0,1,8,
0,2,8,0,2,8,0,2,9,0,
2,9,0,2,9,0,2,10,0,3,
10,0,3,11,0,3,11,0,3,11,
0,3,12,1,4,12,1,4,12,1,
4,13,1,4,13,1,4,14,1,5,
14,1,5,14,1,5,15,1,5,15,
2,5,15,2,6,16,2,6,16,2,
6,17,2,6,17,2,7,17,3,7,
18,3,7,18,3,7,18,3,8,19,
4,8,19,4,8,20,4,8,20,4,
9,20,4,9,21,5,9,21,5,10,
21,5,10,22,5,10,22,6,11,23,
6,11,23,6,11,23,7,11,24,7,
12,24,7,12,24,7,12,25,8,13,
25,8,13,26,8,13,26,9,14,26,
9,14,27,9,14,27,10,15,28,10,
15,28,10,15,28,11,16,29,11,16,
29,11,16,29,12,17,30,12,17,30,
13,18,31,13,18,31,13,18,31,14,
19,32,14,19,32,14,20,32,15,20,
33,15,20,33,16,21,34,16,21,34,
17,22,34,17,22,35,17,22,35,18,
23,35,18,23,36,19,24,36,19,24,
37,20,24,37,20,25,37,21,25,38,
21,26,38,21,26,38,22,27,39,22,
27,39,23,28,40,23,28,40,24,29,
40,24,29,41,25,30,41,25,30,41,
26,31,42,26,31,42,27,31,43,27,
32,43,28,33,43,29,33,44,29,33,
44,30,34,45,30,35,45,31,35,45,
31,36,46,32,36,46,33,37,46,33,
37,47,34,38,47,34,38,48,35,39,
48,36,39,48,36,40,49,37,40,49,
37,41,49,38,42,50,39,42,50,39,
43,51,40,43,51,41,44,51,41,44,
52,42,45,52,43,45,52,43,46,53,
44,47,53,45,47,54,45,48,54,46,
48,54,47,49,55,47,50,55,48,50,
55,49,51,56,49,51,56,50,52,57,
51,53,57,52,53,57,52,54,58,53,
55,58,54,55,58,55,56,59,55,56,
59,56,57,60,57,58,60,58,58,60,
58,59,61,59,60,61,60,60,61,61,
61,62,61,62,62,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63);

var wo,i,a:word;
    px,py,su,xa,ya,za,sza,zo:integer;
    ownseg:word;
    muzak,mver1,ver1,irq1,dma1,db:byte;
    p:pointer;
    f:file;f1:file of byte;
    lx,ly,tx,ty:longint;
    avex,avey,avez:array[0..faces-1] of longint;
    polcol:integer;
    tz:array[0..vertices-1] of longint;
    otd:array[0..faces-1] of word;
    vx,vy,vz:longint;
    dx,dy:array[0..vertices-1] of integer;
    sit,cot:array[0..359] of longint;
    a1,xadd,cadd,yadd,zadd:shortint;
    yco:integer;
    oldintseg,oldintofs,timer:word;
    s:string;
    ma:pointer;
    intno,beatdelay:word;
    currentpal:array[0..768] of integer;
    c:char;
    red, green:longint;
label endi;

procedure mblur(segi:word);
assembler;
asm
   mov es,segi
   xor di,di
   mov cx,65535
@mblur1:
   mov al,[es:di+320]
   add al,[es:di+321]
   add al,[es:di+319]
   add al,[es:di+640]
   shr al, 2
   sub al, 1
   jnc @ok
   xor al,al
@ok:
   mov [es:di],al
   inc di
   dec cx
   jnz @mblur1
end;

procedure quicksort(lo,hi:integer);
var i,j,x,y:longint;
begin i:=lo;j:=hi;x:=avez[(lo+hi) div 2];
repeat
while avez[i]<x do inc(i);while x<avez[j] do dec(j);
if i<=j then begin y:=avez[i];avez[i]:=avez[j];avez[j]:=y;y:=otd[i];otd[i]:=otd[j];otd[j]:=y;inc(i);dec(j);end;
until i>j;
if lo<j then quicksort(lo,j);if i<hi then quicksort(i,hi);
end;

procedure musicint;interrupt;
var t:word;
begin
asm mov al,20h;out 20h,al;end;
if(mver<>0)and(muzak=1)then playmusic;

if(intno=0) then begin
for t:=1 to 255 do
begin
if(currentpal[t*3]>paldata[t*3]) then dec(currentpal[t*3],beatdec);
if(currentpal[t*3+1]>paldata[t*3+1]) then dec(currentpal[t*3+1],beatdec);
if(currentpal[t*3+2]>paldata[t*3+2]) then dec(currentpal[t*3+2],beatdec);

if(currentpal[t*3]<paldata[t*3]) then currentpal[t*3]:=paldata[t*3];
if(currentpal[t*3+1]<paldata[t*3+1]) then currentpal[t*3+1]:=paldata[t*3+1];
if(currentpal[t*3+2]<paldata[t*3+2]) then currentpal[t*3+2]:=paldata[t*3+2];

setpal(t,currentpal[t*3],currentpal[t*3+1],currentpal[t*3+2]);
end;

if(beatdelay=0) then begin
for t:=1 to 255 do  begin
currentpal[t*3]:=63;
currentpal[t*3+1]:=0;
currentpal[t*3+2]:=0;
end;
beatdelay:=beatdel;
end;

dec(beatdelay);
end;
end;

procedure getvect(vec:byte);assembler;
asm mov ah,$35;mov al,vec;int $21;mov oldintseg,es;mov oldintofs,bx;end;

procedure setvect(vec:byte;tseg,tofs:word);assembler;
asm push ds;mov ah,$25;mov al,vec;mov dx,tofs;mov ds,tseg;int $21;pop ds;end;

begin
assign(f1,'payback.cfg');reset(f1);
read(f1,mver1,ver1,mem[seg(base):ofs(base)],mem[seg(base):ofs(base)+1],irq1,dma1);
mver:=mver1;ver:=ver1;irq:=irq1;dma:=dma1;
musics:=mver;if(ver=0)then sounds:=false else sounds:=true;
close(f1);

getmem(ma,12000);tuneseg:=seg(ma^);

s:='intro.svm';
assign(f1,s);reset(f1);wo:=filesize(f1);close(f1);
assign(f,s);reset(f,wo);blockread(f,mem[tuneseg:0],1);close(f);
initplayer(tuneseg);
intno:=0;
beatdelay:=beatdel;

getvect(8);
setvect(8,seg(musicint),ofs(musicint));
timer:=round(1193180/60);
asm cli;push ax;push cx;mov al,36h;out 43h,al;pusha;popa;mov cx,timer;mov al,cl;
out 40h,al;pusha;popa;mov al,ch;out 40h,al;pusha;popa;pop cx;pop ax;sti;end;

muzak:=1;

for wo:=0 to 359 do
begin
sit[wo]:=round(sin(wo*pi/180)*1024);
cot[wo]:=round(cos(wo*pi/180)*1024);
end;

asm
mov ax,13h
int 10h
end;
clearb($a000,65535);
for wo:=0 to 255 do setpal(wo,paldata[wo*3],paldata[wo*3+1],paldata[wo*3+2]);

getmem(p,65535);
ownseg:=seg(p^);
clearb(ownseg,64000);

zo:=750;
xa:=270;
ya:=90;
za:=90;
sza:=0;
su:=10;
yadd:=1;
xadd:=4;
zadd:=2;
yco:=60;
cadd:=0;

clearb(ownseg,64000);

repeat
{clearb(ownseg,64000);}
mblur(ownseg);

for i:=0 to vertices-1 do
begin

vx:=(cot[za]*xcords[i]+sit[za]*(ycords[i]))div 1024;
vy:=(cot[za]*(ycords[i])-sit[za]*xcords[i])div 1024;
vz:=(cot[xa]*zcords[i]-sit[xa]*vy)div 1024;
tx:=(cot[ya]*vx-sit[ya]*vz)div 1024;
ty:=(cot[xa]*vy+sit[xa]*zcords[i])div 1024+yco;
tz[i]:=(cot[ya]*vz+sit[ya]*vx)div 1024;

if(tz[i]=-zo)then inc(tz[i]);
dx[i]:=(tx shl 8) div (tz[i]+zo)+160+sit[za] div 50;
dy[i]:=(ty shl 8) div (tz[i]+zo)+100+cot[za] div 50;

end;

for wo:=0 to faces-1 do
begin
{avex[wo]:=(dx[facea[wo]]+dx[faceb[wo]]+dx[facec[wo]]) div 3;
avey[wo]:=(dy[facea[wo]]+dy[faceb[wo]]+dy[facec[wo]]) div 3;}
avez[wo]:=(tz[facea[wo]]+tz[faceb[wo]]+tz[facec[wo]]) div 3;
otd[wo]:=wo;
end;
quicksort(0,faces-1);

for i:=faces-50 downto 0 do
{if(avex[otd[i]]>-50)and(avex[otd[i]]<370)and(avey[otd[i]]>-50)and(avey[otd[i]]<250)and
(avez[i]+zo>100)then}
begin

polcol:=-(avez[i] shr 1)+70;
if polcol>255 then polcol:=255;
if polcol<0 then polcol:=0;

xquadra(
dx[facea[otd[i]]],dy[facea[otd[i]]],
dx[faceb[otd[i]]],dy[faceb[otd[i]]],
dx[facec[otd[i]]],dy[facec[otd[i]]],
dx[facec[otd[i]]],dy[facec[otd[i]]],
polcol,ownseg);
{
dline(dx[facea[otd[i]]],dy[facea[otd[i]]],
      dx[faceb[otd[i]]],dy[faceb[otd[i]]],polcol,ownseg);
dline(dx[faceb[otd[i]]],dy[faceb[otd[i]]],
      dx[facec[otd[i]]],dy[facec[otd[i]]],polcol,ownseg);
dline(dx[facec[otd[i]]],dy[facec[otd[i]]],
      dx[facea[otd[i]]],dy[facea[otd[i]]],polcol,ownseg);
}
end;

wait(1);
copyb(ownseg,$a000,0,0,64000);

inc(zo,su);
if(zo>3000) then
 begin
 su:=0;
 yadd:=0;
 zadd:=0;
 xadd:=0;
 cadd:=0;

 su:=-4;
 yadd:=2;
 zadd:=4;
 xadd:=1;
 cadd:=0;

 end;

 inc(yco,cadd);

inc(xa,xadd);
if xa>=360 then dec(xa,360);
if xa<0 then inc(xa,360);

inc(ya,yadd);
if ya>=360 then dec(ya,360);
if ya<0 then inc(ya,360);

inc(za,zadd);
if za>=360 then dec(za,360);
if za<0 then inc(za,360);
inc(sza,1);
if sza>359 then dec(sza,360);

if(su<0) and(zo<600) then begin
su:=10;
yadd:=1;
xadd:=4;
zadd:=2;
end;

until keypressed;
{ dummy }
asm xor ax,ax;int 16h;mov c,ah;end;

endi:
{wait(1);}
for i:=0 to 255 do setpal(0,a,a,a);
clearb($a000,64000);
s:='boom.svm';
assign(f1,s);reset(f1);wo:=filesize(f1);close(f1);
assign(f,s);reset(f,wo);blockread(f,mem[tuneseg:0],1);close(f);
initplayer(tuneseg);

intno:=1;
a1:=63;
{for wo:=1 to 64 do begin
wait(3);
setpal(0,a1,a1,a1);
dec(a1,1);
end;
wait(25);
}
muzak:=0;
wait(50);
setvideo(3);
{endplayer;}
setvect(8,oldintseg,oldintofs);
end.
