{$M 1024,0,640000}
uses crt,utils,sbunit;

const beatdec=2;
      beatdel=128;
      mfade=8;
const scaler=16;

const vertices=285;
const faces=562;

const xcords:array[0..vertices-1] of integer=(
-76,-76,-69,-62,-126,-111,-105,-105,-111,-153,-74,-67,-61,-55,-48,-42,-37,
-34,-32,-32,-33,-37,-43,-51,-61,-76,-72,-69,-65,-64,-62,-62,-62,
-63,-64,-68,-72,-76,35,12,20,26,36,-53,-14,-8,3,-21,-15,
-29,-31,50,41,27,90,105,117,141,153,46,47,49,52,57,63,
70,74,79,82,81,78,74,70,67,66,47,47,48,50,57,66,
75,82,89,95,100,103,105,104,102,98,91,79,67,90,-98,-98,
-89,-80,-161,-143,-135,-135,-143,-197,-95,-87,-79,-70,-62,-54,-47,-44,
-42,-41,-43,-48,-56,-65,-78,-98,-93,-88,-84,-82,-80,-80,-80,-81,
-83,-87,-93,-98,45,15,26,34,47,-68,-18,-10,4,-27,-20,-38,
-40,64,52,35,115,135,151,181,197,59,60,63,67,73,81,90,
95,102,105,104,100,96,90,87,85,60,61,62,65,74,85,97,
106,115,122,129,133,134,133,131,127,117,101,86,115,-76,-76,-69,
-62,-126,-111,-105,-105,-111,-153,-74,-67,-61,-55,-48,-42,-37,-34,-32,
-32,-33,-37,-43,-51,-61,-76,-72,-69,-65,-64,-62,-62,-62,-63,-64,
-68,-72,-76,35,12,20,26,36,-53,-14,-8,3,-21,-15,-29,-31,
50,41,27,90,105,117,141,153,46,47,49,52,57,63,70,74,
79,82,81,78,74,70,67,66,47,47,48,50,57,66,75,82,
89,95,100,103,105,104,102,98,91,79,67,90);

const ycords:array[0..vertices-1] of integer=(
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,45,45,
45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,
45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,
45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,
45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,
45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,
45,45,45,45,45,45,45,45,45,45,45,45,45,95,95,95,
95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,
95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,
95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,
95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,
95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,
95,95,95,95,95,95,95,95,95,95,95,95);

const zcords:array[0..vertices-1] of integer=(
-15,-34,-34,-63,-63,-34,-34,33,33,61,61,61,60,60,58,53,45,
38,31,22,10,-1,-9,-13,-14,10,10,10,12,14,17,22,26,
29,31,33,34,34,31,31,-34,-34,-63,-63,-34,-34,31,31,6,
6,61,61,6,6,-21,-21,-33,-50,-62,-62,-45,-31,-20,-10,-1,
6,11,18,28,33,37,38,36,31,23,24,31,38,45,56,61,
63,62,59,55,48,39,27,18,10,2,-5,-17,-33,-33,-19,-44,
-43,-80,-80,-43,-44,42,42,78,78,78,78,77,74,68,59,49,
39,29,12,-1,-11,-16,-19,13,13,13,15,18,22,29,34,37,
40,43,44,44,40,40,-44,-43,-80,-80,-43,-44,40,40,8,8,
79,79,7,8,-27,-27,-43,-65,-80,-80,-58,-40,-26,-13,-1,8,
14,23,35,43,48,49,47,40,30,31,40,49,58,72,79,80,
79,76,71,62,51,35,23,13,3,-6,-22,-43,-43,-15,-34,-34,
-63,-63,-34,-34,33,33,61,61,61,60,60,58,53,45,38,31,
22,10,-1,-9,-13,-14,10,10,10,12,14,17,22,26,29,31,
33,34,34,31,31,-34,-34,-63,-63,-34,-34,31,31,6,6,61,
61,6,6,-21,-21,-33,-50,-62,-62,-45,-31,-20,-10,-1,6,11,
18,28,33,37,38,36,31,23,24,31,38,45,56,61,63,62,
59,55,48,39,27,18,10,2,-5,-17,-33,-33);

const facea:array[0..faces-1] of word=(
10,10,0,5,6,0,28,0,28,28,28,29,29,30,30,31,31,
32,32,33,33,34,34,34,34,35,35,35,36,36,37,37,25,
25,0,1,1,1,44,45,38,38,38,39,49,50,42,45,46,
46,46,46,59,59,60,76,76,77,55,77,78,79,80,80,81,
82,82,83,84,85,85,86,87,87,88,88,89,90,90,91,91,
92,92,92,93,93,93,93,56,60,93,0,0,1,1,2,2,
3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,
11,11,12,12,13,13,14,14,15,15,16,16,17,17,18,18,
19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,
27,27,28,28,29,29,30,30,31,31,32,32,33,33,34,34,
35,35,36,36,37,37,38,38,39,39,40,40,41,41,42,42,
43,43,44,44,45,45,46,46,47,47,48,48,49,49,50,50,
51,51,52,52,53,53,54,54,55,55,56,56,57,57,58,58,
59,59,60,60,61,61,62,62,63,63,64,64,65,65,66,66,
67,67,68,68,69,69,70,70,71,71,72,72,73,73,74,74,
75,75,76,76,77,77,78,78,79,79,80,80,81,81,82,82,
83,83,84,84,85,85,86,86,87,87,88,88,89,89,90,90,
91,91,92,92,93,93,94,94,95,95,96,96,97,97,98,98,
99,99,100,100,101,101,102,102,103,103,104,104,105,105,106,106,
107,107,108,108,109,109,110,110,111,111,112,112,113,113,114,114,
115,115,116,116,117,117,118,118,119,119,120,120,121,121,122,122,
123,123,124,124,125,125,126,126,127,127,128,128,129,129,130,130,
131,131,132,132,133,133,134,134,135,135,136,136,137,137,138,138,
139,139,140,140,141,141,142,142,143,143,144,144,145,145,146,146,
147,147,148,148,149,149,150,150,151,151,152,152,153,153,154,154,
155,155,156,156,157,157,158,158,159,159,160,160,161,161,162,162,
163,163,164,164,165,165,166,166,167,167,168,168,169,169,170,170,
171,171,172,172,173,173,174,174,175,175,176,176,177,177,178,178,
179,179,180,180,181,181,182,182,183,183,184,184,185,185,186,186,
187,187,188,188,189,189,198,197,217,193,193,216,214,215,213,212,
211,211,210,210,209,209,208,208,207,207,206,206,205,204,203,203,
202,201,201,200,200,197,197,196,196,196,193,192,232,232,242,241,
240,240,237,237,230,230,230,229,240,237,247,246,246,264,263,263,
284,262,262,262,262,261,261,261,260,260,260,260,259,259,259,258,
258,257,257,257,256,256,255,255,254,253,253,252,251,250,284,284,
284);

const faceb:array[0..faces-1] of word=(
9,8,28,4,5,27,0,26,24,23,22,28,21,29,20,30,19,
31,18,32,17,33,16,15,14,34,13,12,35,11,36,10,37,
7,25,0,6,3,43,44,53,52,51,38,48,49,41,42,45,
40,39,50,58,57,59,75,74,76,54,73,77,78,79,72,80,
81,71,82,83,84,70,85,86,69,87,68,88,89,67,90,66,
91,65,64,92,63,62,61,55,56,60,1,96,2,97,3,98,
4,99,5,100,6,101,7,102,8,103,9,104,10,105,11,106,
12,107,13,108,14,109,15,110,16,111,17,112,18,113,19,114,
20,115,21,116,22,117,23,118,24,119,0,95,26,121,27,122,
28,123,29,124,30,125,31,126,32,127,33,128,34,129,35,130,
36,131,37,132,25,120,39,134,40,135,41,136,42,137,43,138,
44,139,45,140,46,141,47,142,48,143,49,144,50,145,51,146,
52,147,53,148,38,133,55,150,56,151,57,152,58,153,59,154,
60,155,61,156,62,157,63,158,64,159,65,160,66,161,67,162,
68,163,69,164,70,165,71,166,72,167,73,168,74,169,75,170,
76,171,77,172,78,173,79,174,80,175,81,176,82,177,83,178,
84,179,85,180,86,181,87,182,88,183,89,184,90,185,91,186,
92,187,93,188,94,189,54,149,96,191,97,192,98,193,99,194,
100,195,101,196,102,197,103,198,104,199,105,200,106,201,107,202,
108,203,109,204,110,205,111,206,112,207,113,208,114,209,115,210,
116,211,117,212,118,213,119,214,95,190,121,216,122,217,123,218,
124,219,125,220,126,221,127,222,128,223,129,224,130,225,131,226,
132,227,120,215,134,229,135,230,136,231,137,232,138,233,139,234,
140,235,141,236,142,237,143,238,144,239,145,240,146,241,147,242,
148,243,133,228,150,245,151,246,152,247,153,248,154,249,155,250,
156,251,157,252,158,253,159,254,160,255,161,256,162,257,163,258,
164,259,165,260,166,261,167,262,168,263,169,264,170,265,171,266,
172,267,173,268,174,269,175,270,176,271,177,272,178,273,179,274,
180,275,181,276,182,277,183,278,184,279,185,280,186,281,187,282,
188,283,189,284,149,244,199,198,218,194,195,217,190,216,214,213,
212,218,211,219,210,220,209,221,208,222,207,223,206,205,204,224,
203,202,225,201,226,200,227,197,215,190,196,193,233,234,243,242,
241,228,238,239,231,232,235,230,229,240,248,247,249,265,264,266,
244,263,267,268,269,262,270,271,261,272,273,274,260,275,276,259,
277,258,278,279,257,280,256,281,255,254,282,253,252,251,245,246,
250);

const facec:array[0..faces-1] of word=(
8,7,27,3,3,26,24,25,23,22,21,21,20,20,19,19,18,
18,17,17,16,16,15,14,13,13,12,11,11,10,10,7,7,
6,6,6,3,2,42,42,52,51,50,50,47,47,40,40,40,
39,50,47,57,56,56,74,73,73,94,72,72,72,72,71,71,
71,70,70,70,70,69,69,69,68,68,67,67,67,66,66,65,
65,64,63,63,62,61,60,94,94,94,96,95,97,96,98,97,
99,98,100,99,101,100,102,101,103,102,104,103,105,104,106,105,
107,106,108,107,109,108,110,109,111,110,112,111,113,112,114,113,
115,114,116,115,117,116,118,117,119,118,95,119,121,120,122,121,
123,122,124,123,125,124,126,125,127,126,128,127,129,128,130,129,
131,130,132,131,120,132,134,133,135,134,136,135,137,136,138,137,
139,138,140,139,141,140,142,141,143,142,144,143,145,144,146,145,
147,146,148,147,133,148,150,149,151,150,152,151,153,152,154,153,
155,154,156,155,157,156,158,157,159,158,160,159,161,160,162,161,
163,162,164,163,165,164,166,165,167,166,168,167,169,168,170,169,
171,170,172,171,173,172,174,173,175,174,176,175,177,176,178,177,
179,178,180,179,181,180,182,181,183,182,184,183,185,184,186,185,
187,186,188,187,189,188,149,189,191,190,192,191,193,192,194,193,
195,194,196,195,197,196,198,197,199,198,200,199,201,200,202,201,
203,202,204,203,205,204,206,205,207,206,208,207,209,208,210,209,
211,210,212,211,213,212,214,213,190,214,216,215,217,216,218,217,
219,218,220,219,221,220,222,221,223,222,224,223,225,224,226,225,
227,226,215,227,229,228,230,229,231,230,232,231,233,232,234,233,
235,234,236,235,237,236,238,237,239,238,240,239,241,240,242,241,
243,242,228,243,245,244,246,245,247,246,248,247,249,248,250,249,
251,250,252,251,253,252,254,253,255,254,256,255,257,256,258,257,
259,258,260,259,261,260,262,261,263,262,264,263,265,264,266,265,
267,266,268,267,269,268,270,269,271,270,272,271,273,272,274,273,
275,274,276,275,277,276,278,277,279,278,280,279,281,280,282,281,
283,282,284,283,244,284,200,200,190,195,196,190,218,190,218,218,
218,219,219,220,220,221,221,222,222,223,223,224,224,224,224,225,
225,225,226,226,227,227,215,215,190,191,191,191,234,235,228,228,
228,229,239,240,232,235,236,236,236,236,249,249,250,266,266,267,
245,267,268,269,270,270,271,272,272,273,274,275,275,276,277,277,
278,278,279,280,280,281,281,282,282,282,283,283,283,283,246,250,
283);

const paldata:array[0..767] of integer=(
0,0,0,0,1,6,0,1,6,0,1,
6,0,1,7,0,1,7,0,1,8,
0,2,8,0,2,8,0,2,9,0,
2,9,0,2,9,0,2,10,0,3,
10,0,3,11,0,3,11,0,3,11,
0,3,12,1,4,12,1,4,12,1,
4,13,1,4,13,1,4,14,1,5,
14,1,5,14,1,5,15,1,5,15,
2,5,15,2,6,16,2,6,16,2,
6,17,2,6,17,2,7,17,3,7,
18,3,7,18,3,7,18,3,8,19,
4,8,19,4,8,20,4,8,20,4,
9,20,4,9,21,5,9,21,5,10,
21,5,10,22,5,10,22,6,11,23,
6,11,23,6,11,23,7,11,24,7,
12,24,7,12,24,7,12,25,8,13,
25,8,13,26,8,13,26,9,14,26,
9,14,27,9,14,27,10,15,28,10,
15,28,10,15,28,11,16,29,11,16,
29,11,16,29,12,17,30,12,17,30,
13,18,31,13,18,31,13,18,31,14,
19,32,14,19,32,14,20,32,15,20,
33,15,20,33,16,21,34,16,21,34,
17,22,34,17,22,35,17,22,35,18,
23,35,18,23,36,19,24,36,19,24,
37,20,24,37,20,25,37,21,25,38,
21,26,38,21,26,38,22,27,39,22,
27,39,23,28,40,23,28,40,24,29,
40,24,29,41,25,30,41,25,30,41,
26,31,42,26,31,42,27,31,43,27,
32,43,28,33,43,29,33,44,29,33,
44,30,34,45,30,35,45,31,35,45,
31,36,46,32,36,46,33,37,46,33,
37,47,34,38,47,34,38,48,35,39,
48,36,39,48,36,40,49,37,40,49,
37,41,49,38,42,50,39,42,50,39,
43,51,40,43,51,41,44,51,41,44,
52,42,45,52,43,45,52,43,46,53,
44,47,53,45,47,54,45,48,54,46,
48,54,47,49,55,47,50,55,48,50,
55,49,51,56,49,51,56,50,52,57,
51,53,57,52,53,57,52,54,58,53,
55,58,54,55,58,55,56,59,55,56,
59,56,57,60,57,58,60,58,58,60,
58,59,61,59,60,61,60,60,61,61,
61,62,61,62,62,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63,63,63,63,
63,63,63,63,63,63,63);

var wo,i,a:word;
    px,py,su,xa,ya,za,sza,zo:integer;
    zoomseg1, zoomseg2, ownseg1, ownseg2, curseg, otherseg:word;
    muzak,mver1,ver1,irq1,dma1,db:byte;
    p:pointer;
    f:file;f1:file of byte;
    lx,ly,tx,ty:longint;
    avex,avey,avez:array[0..faces-1] of longint;
    polcol1,polcol2,polcol3:integer;
    tz:array[0..vertices-1] of longint;
    otd:array[0..faces-1] of word;
    vx,vy,vz:longint;
    dx,dy:array[0..vertices-1] of integer;
    sit,cot:array[0..359] of longint;
    a1,xadd,cadd,yadd,zadd:shortint;
    yco:integer;
    oldintseg,oldintofs,timer:word;
    s:string;
    ma:pointer;
    intno,beatdelay:word;
    currentpal:array[0..768] of integer;
    c:char;
    newx, newy, fromoffs, count:longint;
    spx, spy: integer;
label endi;

procedure mblur(segi:word);
assembler;
asm
   mov  dx,curseg
   xor  di,di
   mov  cx,otherseg
   push ds
   mov  ds,zoomseg1
   mov  si,64000
   mov  di,32000

@mblur1:
   xor  ax, ax
   mov  es, cx
   mov  bx, [ds:si]
   mov  al, [es:bx]
   sub  al, mfade
   jnc   @nope1
   xor  al, al
@nope1:
   mov  es, dx
   mov  [es:di], al
   sub  si,2
   dec  di
   jnz  @mblur1
   pop  ds

   push ds
   mov  ds,zoomseg2
   mov  si,64000
   mov  di,32000
@mblur2:
   mov  es, cx
   mov  bx, [ds:si]
   mov  al, [es:bx]
   sub  al, mfade
   jnc   @nope2
   xor  al, al
@nope2:
   mov  es, dx
   mov  [es:di+32000], al
   sub  si,2
   dec  di
   jnz  @mblur2
   pop  ds

end;

procedure quicksort(lo,hi:integer);
var i,j,x,y:longint;
begin i:=lo;j:=hi;x:=avez[(lo+hi) div 2];
repeat
while avez[i]<x do inc(i);while x<avez[j] do dec(j);
if i<=j then begin y:=avez[i];avez[i]:=avez[j];avez[j]:=y;y:=otd[i];otd[i]:=otd[j];otd[j]:=y;inc(i);dec(j);end;
until i>j;
if lo<j then quicksort(lo,j);if i<hi then quicksort(i,hi);
end;

procedure musicint;interrupt;
var t:word;
begin
asm mov al,20h;out 20h,al;end;
if(mver<>0)and(muzak=1)then playmusic;

if(intno=0) then begin
for t:=1 to 255 do
begin
if(currentpal[t*3]>paldata[t*3]) then dec(currentpal[t*3],beatdec);
if(currentpal[t*3+1]>paldata[t*3+1]) then dec(currentpal[t*3+1],beatdec);
if(currentpal[t*3+2]>paldata[t*3+2]) then dec(currentpal[t*3+2],beatdec);

if(currentpal[t*3]<paldata[t*3]) then currentpal[t*3]:=paldata[t*3];
if(currentpal[t*3+1]<paldata[t*3+1]) then currentpal[t*3+1]:=paldata[t*3+1];
if(currentpal[t*3+2]<paldata[t*3+2]) then currentpal[t*3+2]:=paldata[t*3+2];

setpal(t,currentpal[t*3],currentpal[t*3+1],currentpal[t*3+2]);
end;

if(beatdelay=0) then begin
for t:=1 to 255 do  begin
currentpal[t*3]:=63;
currentpal[t*3+1]:=63;
currentpal[t*3+2]:=63;
end;
beatdelay:=beatdel;
end;

dec(beatdelay);
end;

end;

procedure getvect(vec:byte);assembler;
asm mov ah,$35;mov al,vec;int $21;mov oldintseg,es;mov oldintofs,bx;end;

procedure setvect(vec:byte;tseg,tofs:word);assembler;
asm push ds;mov ah,$25;mov al,vec;mov dx,tofs;mov ds,tseg;int $21;pop ds;end;

begin
assign(f1,'payback.cfg');reset(f1);
read(f1,mver1,ver1,mem[seg(base):ofs(base)],mem[seg(base):ofs(base)+1],irq1,dma1);
mver:=mver1;ver:=ver1;irq:=irq1;dma:=dma1;
musics:=mver;if(ver=0)then sounds:=false else sounds:=true;
close(f1);

{getmem(ma,12000);tuneseg:=seg(ma^);

s:='c:\payback\music\start.svm';
assign(f1,s);reset(f1);wo:=filesize(f1);close(f1);
assign(f,s);reset(f,wo);blockread(f,mem[tuneseg:0],1);close(f);}
initplayer(tuneseg);
intno:=0;
beatdelay:=beatdel;

getvect(8);
setvect(8,seg(musicint),ofs(musicint));
timer:=round(1193180/60);
asm cli;push ax;push cx;mov al,36h;out 43h,al;pusha;popa;mov cx,timer;mov al,cl;
out 40h,al;pusha;popa;mov al,ch;out 40h,al;pusha;popa;pop cx;pop ax;sti;end;

muzak:=1;

for wo:=0 to 359 do
begin
sit[wo]:=round(sin(wo*pi/150)*1024);
cot[wo]:=round(cos(wo*pi/180)*1024);
end;

asm
mov ax,13h
int 10h
end;

clearb($a000,65535);
for wo:=0 to 255 do setpal(wo,paldata[wo*3],paldata[wo*3+1],paldata[wo*3+2]);

getmem(p,65535);
ownseg1:=seg(p^);
clearb(ownseg1,65535);
getmem(p,65535);
ownseg2:=seg(p^);
clearb(ownseg2,65535);

getmem(p,65535);
zoomseg1:=seg(p^);
clearb(zoomseg1,65535);
getmem(p,65535);
zoomseg2:=seg(p^);
clearb(zoomseg2,65535);

spx:=0;
spy:=0;
for count:=0 to 31999 do
begin
newx:=round((spx-160)/1.04)+160;
newy:=round((spy-100)/1.01)+100;
fromoffs:=(newy*320)+newx;
memw[zoomseg1:count*2]:=fromoffs;
inc(spx,1);
if(spx=320)then begin inc(spy,1);spx:=0;end;
end;

for count:=32000 to 63999 do
begin
newx:=round((spx-160)/1.04)+160;
newy:=round((spy-100)/1.01)+100;
fromoffs:=(newy*320)+newx;
memw[zoomseg2:count*2-64000]:=fromoffs;
inc(spx,1);
if(spx=320)then begin inc(spy,1);spx:=0;end;
end;

zo:=800;
xa:=270;
ya:=90;
za:=90;
sza:=0;
su:=0;
yadd:=1;
xadd:=4;
zadd:=2;
yco:=60;
cadd:=0;

curseg:=ownseg1;
otherseg:=ownseg2;
repeat
{clearb(ownseg,64000);}
mblur(curseg);

for i:=0 to vertices-1 do
begin

vx:=(cot[za]*xcords[i]+sit[za]*(ycords[i]))div 1024;
vy:=(cot[za]*(ycords[i])-sit[za]*xcords[i])div 1024;
vz:=(cot[xa]*zcords[i]-sit[xa]*vy)div 1024;
tx:=(cot[ya]*vx-sit[ya]*vz)div 1024;
ty:=(cot[xa]*vy+sit[xa]*zcords[i])div 1024+yco;
tz[i]:=(cot[ya]*vz+sit[ya]*vx)div 1024;

if(tz[i]=-zo)then inc(tz[i]);
dx[i]:=(tx shl 8) div (tz[i]+zo)+160+sit[za] div 50;
dy[i]:=(ty shl 8) div (tz[i]+zo)+100+cot[za] div 50;

end;

for wo:=0 to faces-1 do
begin
{avex[wo]:=(dx[facea[wo]]+dx[faceb[wo]]+dx[facec[wo]]) div 3;
avey[wo]:=(dy[facea[wo]]+dy[faceb[wo]]+dy[facec[wo]]) div 3;}
avez[wo]:=(tz[facea[wo]]+tz[faceb[wo]]+tz[facec[wo]]) div 3;
otd[wo]:=wo;
end;
quicksort(0,faces-1);

for i:=faces-50 downto 0 do
{if(avex[otd[i]]>-50)and(avex[otd[i]]<370)and(avey[otd[i]]>-50)and(avey[otd[i]]<250)and
(avez[i]+zo>100)then}
begin

polcol1:=-(avez[i] shr 1)+60;
if polcol1>255 then polcol1:=255;
if polcol1<0 then polcol1:=0;

{polcol1:=-(tz[facea[otd[i]]] shr 3)+60;
if polcol1>255 then polcol1:=255;
if polcol1<0 then polcol1:=0;

polcol2:=-(tz[faceb[otd[i]]] shr 3)+60;
if polcol2>255 then polcol2:=255;
if polcol2<0 then polcol2:=0;

polcol3:=-(tz[facec[otd[i]]] shr 3)+60;
if polcol3>255 then polcol3:=255;
if polcol3<0 then polcol3:=0;}

xquadra(
dx[facea[otd[i]]],dy[facea[otd[i]]],
dx[faceb[otd[i]]],dy[faceb[otd[i]]],
dx[facec[otd[i]]],dy[facec[otd[i]]],
dx[facec[otd[i]]],dy[facec[otd[i]]],
polcol1,curseg);

{xtetragourad(
dx[facea[otd[i]]],dy[facea[otd[i]]],polcol1,
dx[faceb[otd[i]]],dy[faceb[otd[i]]],polcol2,
dx[facec[otd[i]]],dy[facec[otd[i]]],polcol3,
curseg);}

{dline(dx[facea[otd[i]]],dy[facea[otd[i]]],
      dx[faceb[otd[i]]],dy[faceb[otd[i]]],polcol,curseg);
dline(dx[faceb[otd[i]]],dy[faceb[otd[i]]],
      dx[facec[otd[i]]],dy[facec[otd[i]]],polcol,curseg);
dline(dx[facec[otd[i]]],dy[facec[otd[i]]],
      dx[facea[otd[i]]],dy[facea[otd[i]]],polcol,curseg);}

end;

wait(1);
copyb(curseg,$a000,0,0,64000);

inc(zo,su);
if(zo>10000) then
 begin
 su:=0;
 yadd:=0;
 zadd:=0;
 xadd:=0;
 cadd:=0;

 su:=-10;
 yadd:=1;
 zadd:=4;
 xadd:=2;
 cadd:=0;

 end;

 inc(yco,cadd);

inc(xa,xadd);
if xa>=360 then dec(xa,360);
if xa<0 then inc(xa,360);

inc(ya,yadd);
if ya>=360 then dec(ya,360);
if ya<0 then inc(ya,360);

inc(za,zadd);
if za>=360 then dec(za,360);
if za<0 then inc(za,360);
inc(sza,1);
if sza>359 then dec(sza,360);

if(su<0) and(zo<6000) then begin
su:=-10;
yadd:=1;
xadd:=4;
zadd:=2;
end;

if(curseg=ownseg1)then curseg:=ownseg2 else curseg:=ownseg1;
if(otherseg=ownseg1)then otherseg:=ownseg2 else otherseg:=ownseg1;

until keypressed;
{ dummy }
asm xor ax,ax;int 16h;mov c,ah;end;

endi:
{wait(1);}
for i:=0 to 255 do setpal(0,a,a,a);
clearb($a000,64000);
s:='boom.svm';
assign(f1,s);reset(f1);wo:=filesize(f1);close(f1);
assign(f,s);reset(f,wo);blockread(f,mem[tuneseg:0],1);close(f);
initplayer(tuneseg);

intno:=1;
a1:=63;
{for wo:=1 to 64 do begin
wait(3);
setpal(0,a1,a1,a1);
dec(a1,1);
end;
wait(25);
}
muzak:=0;
wait(50);
setvideo(3);
{endplayer;}
setvect(8,oldintseg,oldintofs);
end.
